!function webpackUniversalModuleDefinition(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("ic-stoic-identity",[],t):"object"==typeof exports?exports["ic-stoic-identity"]=t():e["ic-stoic-identity"]=t()}(this,(function(){return(()=>{"use strict";var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{StoicIdentity:()=>StoicIdentity});const i=require("@dfinity/principal"),n=require("@dfinity/agent"),r=require("@dfinity/identity"),o=require("buffer");window.Buffer=o.Buffer;const a=o.Buffer.from((new TextEncoder).encode("\nic-request"));var c="https://www.stoicwallet.com";class PublicKey{constructor(e,t){this._der=e,this._type=t}getType(){return this._type}toDer(){return this._der}}class StoicIdentity extends n.SignIdentity{constructor(e,t){super(),this._principal=e,this._publicKey=t}static disconnect(){return _stoicLogout()}static connect(e){return new Promise((async(t,n)=>{e&&(c=e),_stoicLogin(c).then((e=>{t(new StoicIdentity(i.Principal.fromText(e.principal),new PublicKey(e.key,e.type)))})).catch(n)}))}static load(e){return new Promise((async(t,n)=>{e&&(c=e);var r=_stoicInit();if(!1===r)t(!1);else{var o=new StoicIdentity(i.Principal.fromText(r.principal),new PublicKey(r.key,r.type));o.accounts().then((e=>{t(o)})).catch((e=>{console.log(e),t(!1)}))}}))}getPublicKey(){return this._publicKey}sign(e){return this._transport(buf2hex(e))}_transport(e){return _stoicSign("sign",e,this.getPrincipal().toText())}accounts(){return _stoicSign("accounts","accounts",this.getPrincipal().toText())}transformRequest(e){return new Promise((async(t,i)=>{try{const{body:i,...u}=e,d=await(0,n.requestIdOf)(i),p=this.getPublicKey();var c={...u,body:{content:i}};const y=JSON.parse(await this.sign(o.Buffer.from(o.Buffer.concat([a,new Uint8Array(d)]))));if(c.body.sender_sig=hex2buf(y.signed),"DelegationIdentity"==p.getType()){var s=r.DelegationChain.fromJSON(y.chain);c.body.sender_pubkey=s.publicKey,c.body.sender_delegation=s.delegations}else c.body.sender_pubkey=new Uint8Array(Object.values(p.toDer()));t(c)}catch(e){i(e)}}))}}var s,u,d,p,y=0,l={},f={};const _stoicInit=()=>(p=JSON.parse(localStorage.getItem("_scApp")))||!1,_stoicLogout=()=>{localStorage.removeItem("_scApp"),d="",p=null},_stoicLogin=e=>new Promise((async(t,i)=>{var n=await function _generateKey(){return new Promise((async(e,t)=>{var i=await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-384"},!0,["sign","verify"]),n=await window.crypto.subtle.exportKey("spki",i.publicKey);e({principal:"",key:"",type:"",secretkey:await window.crypto.subtle.exportKey("jwk",i.privateKey),apikey:buf2hex(n)})}))}();d=n.apikey,s=window.open(e+"?authorizeApp","stoic"),u=[e=>{n.principal=e.principal,n.key=e.key,n.type=e.type,p=n,localStorage.setItem("_scApp",JSON.stringify(n)),t(n)},i]})),_stoicSign=(e,t,i)=>new Promise((async function(n,r){var o=(new TextEncoder).encode(t),a=await window.crypto.subtle.importKey("jwk",p.secretkey,{name:"ECDSA",namedCurve:"P-384"},!0,["sign"]),s=buf2hex(await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-384"}},a,o));const u={action:e,payload:t,principal:i,apikey:p.apikey,sig:s};(function _postToFrame(e,t,i){var n=y;y+=1,l[n]=[t,i];var r=document.createElement("iframe");r.setAttribute("id","connect_iframe"+n),r.setAttribute("width","0"),r.setAttribute("height","0"),r.setAttribute("border","0"),document.body.appendChild(r),f[n]={frame:r,type:"iframe"},r.addEventListener("load",(function(){e.listener=n,f[n].frame.contentWindow.postMessage(e,"*")})),r.setAttribute("src",c+"/?stoicTunnel")})(u,n,r)}));function buf2hex(e){return[...new Uint8Array(e)].map((e=>e.toString(16).padStart(2,"0"))).join("")}function hex2buf(e){const t=new Uint8Array(e.length/2);for(let i=0;i<e.length;i+=2)t[i/2]=parseInt(e.substring(i,i+2),16);return t}return window.addEventListener("message",(function(e){if(e.origin==c)if(e&&e.data&&"STOIC-EXT"===e.data.action){const[t,i]=l[e.data.listener]||[];void 0!==e.data.success&&e.data.success?t(e.data.data):i(e.data.data),function _removeFrame(e){"iframe"===f[e].type?f[e].frame.parentNode.removeChild(f[e].frame):"popup"===f[e].type&&f[e].frame.close(),delete f[e]}(e.data.listener),delete l[e.data.listener]}else"initiateStoicConnect"==e.data.action?s.postMessage({action:"requestAuthorization",apikey:d},"*"):"rejectAuthorization"==e.data.action?(u[1]("Authorization Rejected"),u=null,s.close()):"confirmAuthorization"==e.data.action&&(u[0](e.data),u=null,s.close())}),!1),t})()}));