!function webpackUniversalModuleDefinition(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("ic-stoic-identity",[],e):"object"==typeof exports?exports["ic-stoic-identity"]=e():t["ic-stoic-identity"]=e()}(this,(function(){return(()=>{"use strict";var t={d:(e,n)=>{for(var i in n)t.o(n,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:n[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{StoicIdentity:()=>StoicIdentity});const n=require("@dfinity/principal"),i=require("@dfinity/agent"),o=require("@dfinity/identity"),r=require("buffer");window.Buffer=r.Buffer;const a=r.Buffer.from((new TextEncoder).encode("\nic-request"));var s="https://www.stoicwallet.com";let c=!1,p=!1;class PublicKey{constructor(t,e){this._der=t,this._type=e}getType(){return this._type}toDer(){return this._der}}class StoicIdentity extends i.SignIdentity{constructor(t,e,n){super(),this._transportMethod="popup",this._accounts=[],n&&(this._transportMethod=n),this._principal=t,this._publicKey=e}static disconnect(){return _stoicLogout()}static connect(t,e){return t&&(s=t),e&&(this._transportMethod=e),new Promise((async(t,e)=>{_stoicLogin(this._transportMethod).then((e=>{let i=new StoicIdentity(n.Principal.fromText(e.principal),new PublicKey(e.key,e.type),this._transportMethod);t(i)})).catch(e)}))}static load(t,e){return t&&(s=t),e&&(this._transportMethod=e),new Promise((async(t,e)=>{var i=_stoicInit();!1===i?t(!1):t(new StoicIdentity(n.Principal.fromText(i.principal),new PublicKey(i.key,i.type),this._transportMethod))}))}getPublicKey(){return this._publicKey}sign(t){return this._transport(buf2hex(t))}_transport(t){return _stoicSign("sign",t,this.getPrincipal().toText(),this._transportMethod)}accounts(t){return new Promise((async(e,n)=>{!this._accounts.length||t?_stoicSign("accounts","accounts",this.getPrincipal().toText(),this._transportMethod).then((t=>{this._accounts=t,e(this._accounts)})).catch(n):e(this._accounts)}))}transformRequest(t){return new Promise((async(e,n)=>{try{const{body:n,...p}=t,d=await(0,i.requestIdOf)(n),u=this.getPublicKey();var s={...p,body:{content:n}};const l=JSON.parse(await _stoicSign("sign",buf2hex(r.Buffer.from(r.Buffer.concat([a,new Uint8Array(d)]))),this.getPrincipal().toText(),this._transportMethod,t.endpoint,buf2hex(d)));if(s.body.sender_sig=hex2buf(l.signed),"DelegationIdentity"==u.getType()){var c=o.DelegationChain.fromJSON(l.chain);s.body.sender_pubkey=c.publicKey,s.body.sender_delegation=c.delegations}else s.body.sender_pubkey=new Uint8Array(Object.values(u.toDer()));e(s)}catch(t){n(t)}}))}}var d,u,l,y,h=0,f={},g={};const _stoicInit=()=>(y=JSON.parse(localStorage.getItem("_scApp")))||!1,_stoicLogout=()=>{localStorage.removeItem("_scApp"),l="",y=null},_stoicLogin=t=>new Promise((async(t,e)=>{var n=await function _generateKey(){return new Promise((async(t,e)=>{var n=await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-384"},!0,["sign","verify"]),i=await window.crypto.subtle.exportKey("spki",n.publicKey);t({principal:"",key:"",type:"",secretkey:await window.crypto.subtle.exportKey("jwk",n.privateKey),apikey:buf2hex(i)})}))}();l=n.apikey,d=window.open(s+"?authorizeApp","stoic"),u=[e=>{n.principal=e.principal,n.key=e.key,n.type=e.type,y=n,localStorage.setItem("_scApp",JSON.stringify(n)),t(n)},e]})),_stoicSign=(t,e,n,i,o="unknown",r=0)=>new Promise((async function(a,d){var u=(new TextEncoder).encode(e),l=await window.crypto.subtle.importKey("jwk",y.secretkey,{name:"ECDSA",namedCurve:"P-384"},!0,["sign"]),b=buf2hex(await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-384"}},l,u));const w={action:t,payload:e,principal:n,apikey:y.apikey,endpoint:o,requestId:r,sig:b};"popup"===i?(w.target="STOIC-POPUP",function _postToPopup(t,e,n){var i,o=!1;c&&(i=c,o=!0,p&&(clearTimeout(p),p=!1),"call"==t.endpoint||(p=setTimeout((()=>{c=!1,p=!1,_removeFrame(i)}),5e3)));i||(i=h,h+=1);"call"==t.endpoint&&(c=i,p=!1);if(f[i]=[e,n],t.listener=i,t.existing=o,o)g[i].target.postMessage(t,"*");else{const e=window.open(`${s}/?stoicTunnel&transport=popup&lid=`+i,"stoic_"+i,"width=500,height=250,left=100,top=300,toolbar=no,menubar=no,scrollbars=no,resizable=no,status=no");if(!e)return n("Failed to open popup window. It may have been blocked by the browser.");g[i]={target:e,type:"popup",data:t}}}(w,a,d)):(w.target="STOIC-IFRAME",function _postToFrame(t,e,n){var i=h;h+=1,f[i]=[e,n];var o=document.createElement("iframe");o.setAttribute("id","connect_iframe"+i),o.setAttribute("width","0"),o.setAttribute("height","0"),o.setAttribute("border","0"),document.body.appendChild(o),t.listener=i,g[i]={target:o,type:"iframe",data:t},o.addEventListener("load",(function(){g[i].target.contentWindow.postMessage(t,"*")})),o.setAttribute("src",s+"/?stoicTunnel")}(w,a,d))}));function _removeFrame(t){"iframe"===g[t].type?g[t].target.parentNode.removeChild(g[t].target):"popup"===g[t].type&&g[t].target.close(),delete g[t],delete f[t]}function buf2hex(t){return[...new Uint8Array(t)].map((t=>t.toString(16).padStart(2,"0"))).join("")}function hex2buf(t){const e=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2)e[n/2]=parseInt(t.substring(n,n+2),16);return e}return window.addEventListener("message",(function(t){if(t.origin==s&&t&&t.data)if("STOIC-EXT"===t.data.target){const[e,n]=f[t.data.listener]||[];void 0!==t.data.success&&t.data.success?("call"==t.data.message.endpoint||"read_state"==t.data.message.endpoint&&t.data.message.existing||_removeFrame(t.data.listener),e(t.data.data)):n(t.data.data)}else if("stoicPopupLoad"===t.data.action){let e=g[t.data.listener];e.target.postMessage(e.data,"*")}else"initiateStoicConnect"==t.data.action?d.postMessage({action:"requestAuthorization",apikey:l},"*"):"rejectAuthorization"==t.data.action?(u[1]("Authorization Rejected"),u=null,d.close()):"confirmAuthorization"==t.data.action&&(u[0](t.data),u=null,d.close())}),!1),e})()}));